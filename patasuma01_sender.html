<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒã‚¤ã‚¹å‚¾ããƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-md bg-white shadow-xl rounded-xl p-6 space-y-6">
        <h1 class="text-3xl font-extrabold text-gray-800 text-center">ãƒ‡ãƒã‚¤ã‚¹å‚¾ãé€ä¿¡ã‚¢ãƒ—ãƒª</h1>
        <p class="text-center text-sm text-gray-500">ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸãƒ‡ãƒã‚¤ã‚¹ã®å‘ãã‚’Firebaseã«é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚</p>

        <!-- ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãƒœã‚¿ãƒ³ -->
        <div id="permission-container" class="space-y-4">
            <button id="request-permission" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md">
                ã‚¹ãƒ†ãƒƒãƒ— 1: ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹ (iOS Safariå‘ã‘)
            </button>
            <p class="text-xs text-red-500 text-center">â€»Androidã‚„Chromeã§ã¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ãšã«å‹•ä½œã™ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚</p>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div class="border-t pt-4 space-y-3">
            <div class="flex justify-between items-center">
                <span class="text-lg font-semibold text-gray-700">ãƒ‡ãƒã‚¤ã‚¹ID:</span>
                <code id="device-id-display" class="bg-gray-100 p-1 rounded text-sm text-gray-600 truncate">-- å–å¾—ä¸­ --</code>
            </div>

            <div class="flex justify-between items-center p-3 rounded-lg border bg-blue-50">
                <span class="text-lg font-semibold text-blue-700">ç¾åœ¨ã®å‘ã:</span>
                <span id="orientation-status" class="text-lg font-bold text-blue-800">æœªåˆ¤å®š</span>
            </div>

            <div class="flex justify-between items-center text-sm text-gray-500">
                <span>æœ€çµ‚é€ä¿¡æ™‚åˆ»:</span>
                <span id="last-sent-time">--</span>
            </div>
        </div>
    </div>

    <script type="module">
        // ------------------- 1. Firebase SDK ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // ------------------- 2. Firebase è¨­å®š (ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›æƒ…å ±) -------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDQ373qTIdPRKOtlxhF9wyzzNyqWZdXHiM",
            authDomain: "patasuma01.firebaseapp.com",
            databaseURL: "https://patasuma01-default-rtdb.firebaseio.com",
            projectId: "patasuma01",
            storageBucket: "patasuma01.firebasestorage.app",
            messagingSenderId: "4535084397",
            appId: "1:4535084397:web:b80a44af475d2f48e6a664"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ------------------- 3. UIè¦ç´ ã¨å®šæ•°ã®è¨­å®š -------------------
        const statusElement = document.getElementById('orientation-status');
        const lastSentTimeElement = document.getElementById('last-sent-time');
        const deviceIdDisplayElement = document.getElementById('device-id-display');
        const permissionButton = document.getElementById('request-permission');
        const permissionContainer = document.getElementById('permission-container');

        // ãƒ‡ãƒã‚¤ã‚¹è­˜åˆ¥ã®ãŸã‚ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ç”Ÿæˆï¼ˆåˆå›ã®ã¿ï¼‰
        let deviceId = localStorage.getItem('deviceId');
        if (!deviceId) {
            deviceId = crypto.randomUUID();
            localStorage.setItem('deviceId', deviceId);
        }
        deviceIdDisplayElement.textContent = deviceId;

        // åˆ¤å®šã«ä½¿ç”¨ã™ã‚‹è¨±å®¹èª¤å·®ï¼ˆã—ãã„å€¤ï¼‰
        const THRESHOLD_ANGLE = 15; // 15åº¦ä»¥å†…ã‚’è¨±å®¹ç¯„å›²ã¨ã™ã‚‹
        let lastOrientation = 'UNKNOWN';

        // ------------------- 4. ãƒ‡ãƒ¼ã‚¿é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ -------------------

        /**
         * ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç¾åœ¨ã®çŠ¶æ…‹ã‚’é€ä¿¡ã™ã‚‹
         * é€ä¿¡ã¯ãƒ‡ãƒã‚¤ã‚¹IDã‚’ã‚­ãƒ¼ã¨ã™ã‚‹
         * @param {string} orientation - 'UP' or 'DOWN'
         */
        function sendToFirebase(orientation) {
            if (orientation !== lastOrientation) {
                lastOrientation = orientation; // çŠ¶æ…‹ãŒå¤‰åŒ–ã—ãŸå ´åˆã®ã¿æ›´æ–°
            }
            
            const deviceRef = ref(db, 'devices/' + deviceId);
            
            set(deviceRef, {
                orientation: lastOrientation,
                lastSeen: serverTimestamp(),
                // ç”»é¢å‘ããŒUP/DOWNã‚’åˆ¤å®šã—ã‚„ã™ã„ã‚ˆã†ã«è§’åº¦ã‚‚é€ã£ã¦ãŠã
                currentStatus: statusElement.textContent 
            })
            .then(() => {
                const now = new Date();
                lastSentTimeElement.textContent = now.toLocaleTimeString();
                console.log(`[Firebase] Data sent successfully: ${lastOrientation}`);
            })
            .catch((error) => {
                // é€šå¸¸ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«é•åã§ç™ºç”Ÿã—ã‚„ã™ã„
                console.error("[Firebase] Error sending data:", error);
                statusElement.textContent = `DBã‚¨ãƒ©ãƒ¼: ${lastOrientation} (ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèª)`;
            });
        }
        
        // 5ç§’ã”ã¨ã«å¼·åˆ¶çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
        setInterval(() => {
            // lastOrientationã«å‰å›ã®å€¤ãŒå…¥ã£ã¦ã„ã‚‹ã¯ãš
            if (lastOrientation !== 'UNKNOWN') {
                sendToFirebase(lastOrientation);
            }
        }, 5000); // 5ç§’é–“éš”

        // ------------------- 5. å‚¾ãæ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ -------------------

        /**
         * ç”»é¢ã®å‘ãã‚’åˆ¤å®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
         * @param {number} beta - ãƒ”ãƒƒãƒï¼ˆXè»¸å‘¨ã‚Š: å‰å¾Œã®å‚¾ã, -180 to 180ï¼‰
         * @param {number} gamma - ãƒ­ãƒ¼ãƒ«ï¼ˆYè»¸å‘¨ã‚Š: å·¦å³ã®å‚¾ã, -90 to 90ï¼‰
         */
        function checkOrientation(beta, gamma) {
            let orientation = 'UNKNOWN';
            let statusText = 'åˆ¤å®šä¸­...';

            // 1. ç”»é¢ãŒä¸Šå‘ã (Face Up) ã®åˆ¤å®š
            // å‚¾ããŒå°‘ãªã„çŠ¶æ…‹ (0åº¦ä»˜è¿‘)
            if (
                Math.abs(beta) < THRESHOLD_ANGLE &&
                Math.abs(gamma) < THRESHOLD_ANGLE
            ) {
                orientation = 'UP';
                statusText = 'âœ… ç”»é¢ã¯ä¸Šå‘ãã§ã™';
            }
            
            // 2. ç”»é¢ãŒä¸‹å‘ã (Face Down) ã®åˆ¤å®š
            // betaãŒ180åº¦ä»˜è¿‘ï¼ˆè£è¿”ã—ï¼‰ã®çŠ¶æ…‹
            // Math.abs(beta)ãŒ 180 - THRESHOLD_ANGLE (165åº¦) ã‚ˆã‚Šå¤§ãã„
            else if (
                Math.abs(beta) > (180 - THRESHOLD_ANGLE) 
            ) {
                orientation = 'DOWN';
                statusText = 'ğŸ›‘ ç”»é¢ã¯ä¸‹å‘ãã§ã™';
            } else {
                // ä¸­é–“çš„ãªçŠ¶æ…‹ï¼ˆç¸¦ç½®ãã€æ¨ªç½®ããªã©ï¼‰
                orientation = 'SIDE';
                statusText = `â–¶ï¸ æ¨ªå‘ã/ç¸¦å‘ã (Î²:${beta.toFixed(1)}, Î³:${gamma.toFixed(1)})`;
            }

            statusElement.textContent = statusText;

            // å‘ããŒUPã¾ãŸã¯DOWNã«å¤‰ã‚ã£ãŸå ´åˆã€å³åº§ã«Firebaseã«é€ä¿¡
            if (orientation === 'UP' || orientation === 'DOWN') {
                if (orientation !== lastOrientation) {
                     sendToFirebase(orientation);
                }
            }
            lastOrientation = orientation;
        }


        // ------------------- 6. ã‚»ãƒ³ã‚µãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆåˆæœŸåŒ–ã¨è¨±å¯è¦æ±‚ -------------------

        function initOrientationListener() {
            if ('DeviceOrientationEvent' in window) {
                window.addEventListener('deviceorientation', function(event) {
                    // è§’åº¦ãŒnullã§ãªã„ã“ã¨ã‚’ç¢ºèª
                    if (event.beta !== null && event.gamma !== null) {
                        checkOrientation(event.beta, event.gamma);
                    }
                });
                console.log("[Sensor] DeviceOrientation listener active.");
            } else {
                statusElement.textContent = 'ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ã‚¦ã‚¶éå¯¾å¿œ';
            }
            permissionContainer.style.display = 'none'; // è¨±å¯å¾Œã«ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        }

        // iOS 13ä»¥é™ã®Safariã§è¨±å¯ã‚’è¦æ±‚ã™ã‚‹é–¢æ•°
        permissionButton.addEventListener('click', () => {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            initOrientationListener();
                        } else {
                            statusElement.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚';
                        }
                    })
                    .catch(console.error);
            } else {
                // iOS Safariä»¥å¤– or å¤ã„iOSã®å ´åˆã€ãã®ã¾ã¾ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
                initOrientationListener();
            }
        });

        // åˆæœŸçŠ¶æ…‹ã®ãƒã‚§ãƒƒã‚¯ï¼ˆè¨±å¯è¦æ±‚ãŒä¸è¦ãªç’°å¢ƒã§ã¯å³åº§ã«é–‹å§‹ï¼‰
        if (typeof DeviceOrientationEvent.requestPermission !== 'function') {
            initOrientationListener();
        }

    </script>
</body>
</html>
