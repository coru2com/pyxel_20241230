<!DOCTYPE html>
<html>
<head>
    <title>ã‚¹ãƒãƒ›å‚¾ããƒã‚§ãƒƒã‚¯</title>
</head>
<body>
    <h1>ãƒ‡ãƒã‚¤ã‚¹ã®å‘ã</h1>
    <p id="orientation-status">ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„...</p>
    <button id="request-permission">ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹ (iOS Safariå‘ã‘)</button>

<script>
const statusElement = document.getElementById('orientation-status');
const permissionButton = document.getElementById('request-permission');

// åˆ¤å®šã«ä½¿ç”¨ã™ã‚‹è¨±å®¹èª¤å·®ï¼ˆã—ãã„å€¤ï¼‰
const THRESHOLD_ANGLE = 15; // 15åº¦ä»¥å†…ã‚’è¨±å®¹ç¯„å›²ã¨ã™ã‚‹

/**
 * ç”»é¢ã®å‘ãã‚’åˆ¤å®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
 * @param {number} beta - ãƒ”ãƒƒãƒï¼ˆXè»¸å‘¨ã‚Š: å‰å¾Œã®å‚¾ãï¼‰
 * @param {number} gamma - ãƒ­ãƒ¼ãƒ«ï¼ˆYè»¸å‘¨ã‚Š: å·¦å³ã®å‚¾ãï¼‰
 */
function checkOrientation(beta, gamma) {
    let orientation = 'ä¸æ˜';

    // 1. ç”»é¢ãŒä¸Šå‘ã (Face Up) ã®åˆ¤å®š
    // ã»ã¨ã‚“ã©å‚¾ããŒãªã„çŠ¶æ…‹ï¼ˆbeta, gammaãŒ0åº¦ä»˜è¿‘ï¼‰
    if (
        Math.abs(beta) < THRESHOLD_ANGLE &&
        Math.abs(gamma) < THRESHOLD_ANGLE
    ) {
        orientation = 'âœ… ç”»é¢ã¯ä¸Šå‘ãã§ã™ (Face Up)';
    }

    // 2. ç”»é¢ãŒä¸‹å‘ã (Face Down) ã®åˆ¤å®š
    // betaãŒ180åº¦ä»˜è¿‘ï¼ˆè£è¿”ã—ï¼‰ã®çŠ¶æ…‹
    // betaã¯ -180 ã‹ã‚‰ 180 ã®ç¯„å›²
    else if (
        Math.abs(beta) > (180 - THRESHOLD_ANGLE) // 165åº¦ï½180åº¦
    ) {
        // gammaã¯ç„¡è¦–ã—ã¦ã€è£è¿”ã—ã«è¿‘ã„çŠ¶æ…‹ã‚’æ¤œå‡º
        orientation = 'ğŸ›‘ ç”»é¢ã¯ä¸‹å‘ãã§ã™ (Face Down)';
    }

    statusElement.textContent = orientation;
    // å°†æ¥çš„ã«Firebaseã«é€ä¿¡ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«çµ„ã¿è¾¼ã¿ã¾ã™
    // sendToFirebase(orientation);
}


// --- ã‚»ãƒ³ã‚µãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²ã¨è¨±å¯è¦æ±‚ ---

function initOrientationListener() {
    if ('DeviceOrientationEvent' in window) {
        window.addEventListener('deviceorientation', function(event) {
            // event.beta (ãƒ”ãƒƒãƒ) ã¨ event.gamma (ãƒ­ãƒ¼ãƒ«) ã‚’ä½¿ç”¨
            const beta = event.beta;
            const gamma = event.gamma;

            // è§’åº¦ãŒnullã§ãªã„ã“ã¨ã‚’ç¢ºèª
            if (beta !== null && gamma !== null) {
                checkOrientation(beta, gamma);
            }
        });
        statusElement.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿å—ä¿¡å¾…ã¡...';
    } else {
        statusElement.textContent = 'ã‚¨ãƒ©ãƒ¼: ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯DeviceOrientationEventã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚';
    }
    permissionButton.style.display = 'none'; // è¨±å¯å¾Œã«ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
}

// iOS 13ä»¥é™ã®Safariã§è¨±å¯ã‚’è¦æ±‚ã™ã‚‹é–¢æ•°
permissionButton.addEventListener('click', () => {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(permissionState => {
                if (permissionState === 'granted') {
                    initOrientationListener();
                } else {
                    statusElement.textContent = 'ã‚»ãƒ³ã‚µãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚';
                }
            })
            .catch(console.error);
    } else {
        // iOS Safariä»¥å¤– or å¤ã„iOSã®å ´åˆã€ãã®ã¾ã¾ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
        initOrientationListener();
    }
});

// åˆæœŸçŠ¶æ…‹ã®ãƒã‚§ãƒƒã‚¯
// è¨±å¯è¦æ±‚é–¢æ•°ãŒã‚ã‚‹å ´åˆã¯ã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã‚’å¾…ã¤
if (typeof DeviceOrientationEvent.requestPermission !== 'function') {
    initOrientationListener();
}
</script>
</body>
</html>
